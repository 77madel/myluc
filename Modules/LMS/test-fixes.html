<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test des Corrections</title>
    <meta name="csrf-token" content="test-token">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .test-button { 
            background: #007bff; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .log { 
            background: #f1f3f4; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test des Corrections du Syst√®me de Progression</h1>
    
    <div class="test-section">
        <h3>üìã Tests Disponibles</h3>
        <button class="test-button" onclick="testMultipleInitialization()">Test Chargement Multiple</button>
        <button class="test-button" onclick="testJSONParsing()">Test Parsing JSON</button>
        <button class="test-button" onclick="testVideoDetection()">Test D√©tection Vid√©o</button>
        <button class="test-button" onclick="testErrorHandling()">Test Gestion Erreurs</button>
        <button class="test-button" onclick="clearLogs()">Effacer Logs</button>
    </div>
    
    <div class="test-section">
        <h3>üìù Logs de Test</h3>
        <div id="test-logs" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>üéØ R√©sultats Attendus</h3>
        <ul>
            <li class="success">‚úÖ Chargement unique (pas de r√©p√©tition)</li>
            <li class="success">‚úÖ Parsing JSON correct</li>
            <li class="success">‚úÖ D√©tection vid√©o am√©lior√©e</li>
            <li class="success">‚úÖ Gestion des erreurs Flasher</li>
        </ul>
    </div>
    
    <script>
        let testCount = 0;
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '';
            addLog('üßπ Logs effac√©s', 'info');
        }
        
        // Test 1: Chargement multiple
        function testMultipleInitialization() {
            addLog('üß™ Test: Chargement Multiple', 'info');
            
            // Simuler le syst√®me de protection
            if (window.autoProgressInitialized) {
                addLog('‚ö†Ô∏è Syst√®me d√©j√† initialis√© - Protection active', 'warning');
            } else {
                window.autoProgressInitialized = true;
                addLog('‚úÖ Premier chargement - Syst√®me initialis√©', 'success');
            }
            
            // Tenter un deuxi√®me chargement
            if (window.autoProgressInitialized) {
                addLog('‚ö†Ô∏è Deuxi√®me tentative - Bloqu√©e par protection', 'warning');
            }
        }
        
        // Test 2: Parsing JSON
        function testJSONParsing() {
            addLog('üß™ Test: Parsing JSON', 'info');
            
            // Simuler une r√©ponse JSON
            const jsonResponse = {
                "status": "success",
                "view": "<div class='video-content'><h2>Test Video</h2><video controls><source src='test.mp4'></video></div>"
            };
            
            const htmlResponse = "<div class='video-content'><h2>Test Video</h2><video controls><source src='test.mp4'></video></div>";
            
            // Test parsing JSON
            try {
                const parsed = JSON.parse(JSON.stringify(jsonResponse));
                if (parsed.view) {
                    addLog('‚úÖ JSON parsing r√©ussi - View extraite', 'success');
                    addLog(`üìÑ Contenu: ${parsed.view.substring(0, 50)}...`, 'info');
                }
            } catch (e) {
                addLog('‚ùå Erreur parsing JSON: ' + e.message, 'error');
            }
            
            // Test HTML direct
            if (htmlResponse.includes('<video')) {
                addLog('‚úÖ HTML direct d√©tect√© - Pas de parsing n√©cessaire', 'success');
            }
        }
        
        // Test 3: D√©tection vid√©o
        function testVideoDetection() {
            addLog('üß™ Test: D√©tection Vid√©o', 'info');
            
            // Cr√©er des √©l√©ments de test
            const testVideo = document.createElement('video');
            testVideo.id = 'test-video';
            testVideo.controls = true;
            document.body.appendChild(testVideo);
            
            const testIframe = document.createElement('iframe');
            testIframe.src = 'https://www.youtube.com/embed/test';
            testIframe.style.display = 'none';
            document.body.appendChild(testIframe);
            
            const videoSelectors = [
                '#test-video',
                'video',
                'iframe[src*="youtube"]',
                'iframe[src*="embed"]'
            ];
            
            let foundElements = 0;
            for (const selector of videoSelectors) {
                const elements = document.querySelectorAll(selector);
                addLog(`üîç Selector "${selector}": ${elements.length} √©l√©ment(s) trouv√©(s)`, 'info');
                foundElements += elements.length;
            }
            
            if (foundElements > 0) {
                addLog('‚úÖ √âl√©ments vid√©o d√©tect√©s avec succ√®s', 'success');
            } else {
                addLog('‚ùå Aucun √©l√©ment vid√©o trouv√©', 'error');
            }
            
            // Nettoyer
            testVideo.remove();
            testIframe.remove();
        }
        
        // Test 4: Gestion des erreurs
        function testErrorHandling() {
            addLog('üß™ Test: Gestion Erreurs', 'info');
            
            // Simuler une erreur Flasher
            try {
                throw new Error('Flasher is not loaded');
            } catch (e) {
                if (e.message.includes('Flasher')) {
                    addLog('‚ö†Ô∏è Erreur Flasher captur√©e et ignor√©e', 'warning');
                } else {
                    addLog('‚ùå Erreur non-Flasher: ' + e.message, 'error');
                }
            }
            
            // Test gestion globale
            const originalError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                if (msg && msg.includes('Flasher')) {
                    addLog('‚úÖ Gestionnaire global: Erreur Flasher ignor√©e', 'success');
                    return true; // Emp√™cher l'affichage de l'erreur
                }
                return false;
            };
            
            // Simuler une erreur
            setTimeout(() => {
                addLog('‚úÖ Gestionnaire d\'erreur global configur√©', 'success');
                window.onerror = originalError; // Restaurer
            }, 100);
        }
        
        // Initialisation
        addLog('üöÄ Syst√®me de test initialis√©', 'success');
        addLog('üí° Cliquez sur les boutons pour tester chaque fonction', 'info');
    </script>
</body>
</html>

